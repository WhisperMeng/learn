# JVM组成结构

  - 堆：java虚拟机用来存储对象实例，堆中对象需要等待垃圾器进行回收。
  
  - 方法区：线程共享，通常用来保存类的信息、常量信息、常量池信息、包括字符串字面量和数字常量等。需要等待垃圾器进行回收。
  
  - 栈：负责java程序的运行，在线程创建时创建，和线程生命周期一致。不存在垃圾回收问题。
  
  - 本地方法栈：主要作用是登记native方法，native方法是调用非java代码的接口。
  
  - 程序计数器：方法区中的方法字节码由引擎读取下一条指令，线程私有，相当于指针。

## Java堆

  根据垃圾回收机制的不同，Java堆有可能拥有不同的结构，最为常见的就是将整个Java堆分为新生代和老年代。
  
  - 新生代存放新生的对象或者年龄不大的对象，
  - 老年代则存放老年对象。

  新生代分为
  
    - edn区
    - s0区
    - s1区
    
  s0和s1也被称为from和to区域，他们是两块大小相等并且可以互相角色的空间。
  绝大多数情况下，对象首先分配到edn区域，在新生代回收后，如果对象还存在则进入s0区域，之后每经过一次新生代回收，它的存活年龄就+1，达到一定年龄之后进入老年代。该临界值由参数：-XX:MaxTenuringThreshold来设置。
  
## Java栈

  线程私有空间，一般由三部分组成：
  
    - 局部变量表：保存函数的参数及局部变量
    - 操作数据栈：保存计算过程的中间结果，同时作为计算过程中的变量临时存储空间
    - 帧数据区：保存一些支持常量池解析的数据
    
# JVM参数配置
    
    在虚拟机运行的过程中，如果可以跟踪系统的运行状态，那么对于问题的故障排查会有一定的帮助。为此，在虚拟机提供了一些跟踪系统状态的参数，使用给定的参数执行Java虚拟机，就可以在系统运行时打印相关日志，用于分析实际问题。我们进行虚拟机参数配置，其实就是围绕着堆、栈、方法区、进行配置。而最多的就是关于堆内存中新生代和老年代的参数配置。

## 堆的参数配置

  - -XX:+PrintGC 每次触发GC的时候打印相关日志
  - -XX:+UseSerialGC 串行回收
  - -XX:+PrintGCDetails 更详细的GC日志
  - -Xms 堆初始值
  - -Xmx 堆最大可用值
  - -Xmn 新生代堆最大可用值
  - -XX:SurvivorRatio 新生代中eden空间和from/to空间的比例
  - -XX:SurvivorRatio=eden/from=den/to
  
  总结:在实际工作中，我们可以直接将初始的堆大小与最大堆大小相等，这样的好处是可以减少程序运行时垃圾回收次数，从而提高效率。
   
  - 新生代大小，一般设为整个堆的1/3到1/4左右
  - 设置新生代中eden区和from/to空间的比例关系n/1
  
  尽可能将对象预留在新生代，减少老年代的GC次数。除了可以设置新生代的绝对大小(-Xmn),可以使用(-XX:NewRatio)设置新生代和老年代的比例:-XX:NewRatio=老年代/新生代

  内存溢出
  
    - java.lang.OutOfMemoryError: Java heap space：堆内存设置小了
    - java.lang.StackOverflowError：栈溢出。产生于递归调用，循环遍历是不会的。但是循环方法里面产生递归调用，也会发生栈溢出。加大线程最大调用深度：-Xss。
    
  
